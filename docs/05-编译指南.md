# 编译指南

## 环境要求

### 必需软件

1. **Java Development Kit (JDK)**
   - 版本: JDK 17
   - 下载: [Oracle JDK](https://www.oracle.com/java/technologies/downloads/#java17) 或 [OpenJDK](https://adoptium.net/)

2. **Android SDK**
   - 最低要求: Android SDK Platform 26 (Android 8.0)
   - 目标版本: Android SDK Platform 36 (Android 14)
   - 包含: Android SDK Build-Tools, Android SDK Platform-Tools

3. **Gradle**
   - 版本: 项目使用Gradle Wrapper，会自动下载
   - 无需手动安装

### 推荐工具

1. **Android Studio**
   - 最新稳定版本
   - 包含Android SDK和Gradle
   - 提供完整的开发环境

2. **命令行工具**（可选）
   - Git（用于版本控制）
   - 文本编辑器（VS Code、Sublime等）

## 环境配置

### 1. 安装JDK 17

#### Windows

1. 下载JDK 17安装包
2. 运行安装程序
3. 配置环境变量：
   - `JAVA_HOME`: JDK安装路径（如 `C:\Program Files\Java\jdk-17`）
   - 将 `%JAVA_HOME%\bin` 添加到 `PATH`

验证安装：
```powershell
java -version
# 应显示 java version "17.x.x"
```

#### Linux/Mac

```bash
# Ubuntu/Debian
sudo apt-get install openjdk-17-jdk

# macOS (使用Homebrew)
brew install openjdk@17

# 验证
java -version
```

### 2. 安装Android SDK

#### 使用Android Studio（推荐）

1. 下载并安装Android Studio
2. 打开Android Studio，选择"More Actions" → "SDK Manager"
3. 安装以下组件：
   - Android SDK Platform 36
   - Android SDK Build-Tools
   - Android SDK Platform-Tools
   - Android SDK Command-line Tools

#### 使用命令行工具

1. 下载[Android Command Line Tools](https://developer.android.com/studio#command-tools)
2. 解压到合适位置
3. 配置环境变量：
   ```bash
   export ANDROID_HOME=/path/to/android/sdk
   export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
   ```
4. 安装SDK组件：
   ```bash
   sdkmanager "platform-tools" "platforms;android-36" "build-tools;34.0.0"
   ```

### 3. 配置Gradle

项目使用Gradle Wrapper，首次构建时会自动下载Gradle。

如果需要手动配置：
1. 编辑 `gradle/wrapper/gradle-wrapper.properties`
2. 确保Gradle版本兼容

## 编译步骤

### 方法一：使用Android Studio（推荐）

1. **打开项目**
   - 启动Android Studio
   - 选择 "Open" 或 "Import Project"
   - 选择项目根目录（包含`build.gradle.kts`的目录）

2. **同步项目**
   - Android Studio会自动检测项目
   - 点击 "Sync Now" 同步Gradle依赖
   - 等待依赖下载完成

3. **选择构建变体**
   - 打开 "Build Variants" 工具窗口
   - 选择需要的变体：
     - `coreDebug` / `coreRelease`
     - `fossDebug` / `fossRelease`
     - `gplayDebug` / `gplayRelease`

4. **编译项目**
   - 菜单: `Build` → `Make Project` (Ctrl+F9 / Cmd+F9)
   - 或点击工具栏的构建图标

5. **生成APK**
   - 菜单: `Build` → `Build Bundle(s) / APK(s)` → `Build APK(s)`
   - APK位置: `app/build/outputs/apk/{variant}/app-{variant}.apk`

### 方法二：使用命令行

#### Windows (PowerShell)

```powershell
# 1. 进入项目目录
cd C:\Users\Administrator\Desktop\Voice-Recorder

# 2. 赋予gradlew执行权限（首次需要）
# Windows通常不需要，但确保gradlew.bat可执行

# 3. 清理项目（可选）
.\gradlew.bat clean

# 4. 编译Debug版本
.\gradlew.bat assembleDebug

# 5. 编译Release版本（需要签名配置）
.\gradlew.bat assembleRelease

# 6. 编译特定变体
.\gradlew.bat assembleFossDebug
.\gradlew.bat assembleGplayRelease
```

#### Linux/Mac

```bash
# 1. 进入项目目录
cd ~/Voice-Recorder

# 2. 赋予gradlew执行权限（首次需要）
chmod +x gradlew

# 3. 清理项目（可选）
./gradlew clean

# 4. 编译Debug版本
./gradlew assembleDebug

# 5. 编译Release版本（需要签名配置）
./gradlew assembleRelease

# 6. 编译特定变体
./gradlew assembleFossDebug
./gradlew assembleGplayRelease
```

## 构建变体说明

项目支持三种构建变体，每种都有Debug和Release版本：

### 1. Core
- 基础版本
- 包含所有功能

### 2. FOSS
- 自由开源软件版本
- 可能移除某些专有组件

### 3. GPlay
- Google Play版本
- 针对Google Play商店优化

## 签名配置（Release版本）

### 方法一：使用keystore.properties文件

1. 复制示例文件：
   ```bash
   cp keystore.properties_sample keystore.properties
   ```

2. 编辑 `keystore.properties`：
   ```properties
   storeFile=path/to/your/keystore.jks
   storePassword=your_store_password
   keyAlias=your_key_alias
   keyPassword=your_key_password
   ```

3. 创建密钥库（如果还没有）：
   ```bash
   keytool -genkey -v -keystore your-keystore.jks -alias your-alias -keyalg RSA -keysize 2048 -validity 10000
   ```

### 方法二：使用环境变量

设置以下环境变量：
- `SIGNING_KEY_ALIAS`
- `SIGNING_KEY_PASSWORD`
- `SIGNING_STORE_FILE`
- `SIGNING_STORE_PASSWORD`

### 方法三：跳过签名（仅用于测试）

Release版本默认需要签名。如果只是测试，可以：
1. 使用Debug版本
2. 或修改`build.gradle.kts`临时禁用签名检查

## 常见问题

### 1. Gradle同步失败

**问题**: 依赖下载失败或超时

**解决方案**:
- 检查网络连接
- 配置代理（如果需要）：
  ```properties
  # gradle.properties
  systemProp.http.proxyHost=proxy.example.com
  systemProp.http.proxyPort=8080
  ```
- 使用国内镜像（如果在中国）

### 2. JDK版本不匹配

**问题**: 提示需要JDK 17

**解决方案**:
- 确保安装了JDK 17
- 在Android Studio中配置：
  - `File` → `Project Structure` → `SDK Location`
  - 设置JDK路径

### 3. SDK版本不匹配

**问题**: 找不到Android SDK Platform 36

**解决方案**:
- 打开SDK Manager
- 安装Android SDK Platform 36
- 或修改`gradle/libs.versions.toml`中的版本号

### 4. 内存不足

**问题**: Gradle构建时内存溢出

**解决方案**:
编辑 `gradle.properties`:
```properties
org.gradle.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=512m
```

### 5. 依赖下载慢

**解决方案**:
- 使用国内镜像源
- 配置Gradle使用代理
- 使用离线模式（如果已下载依赖）

## 验证编译结果

编译成功后，检查以下文件：

1. **APK文件**:
   ```
   app/build/outputs/apk/{variant}/app-{variant}.apk
   ```

2. **构建报告**:
   ```
   app/build/outputs/logs/
   ```

3. **检查APK信息**:
   ```bash
   # 使用aapt工具（Android SDK自带）
   aapt dump badging app-debug.apk
   ```

## 安装到设备

### 使用ADB

```bash
# 连接设备
adb devices

# 安装APK
adb install app/build/outputs/apk/debug/app-debug.apk

# 或安装并替换现有应用
adb install -r app/build/outputs/apk/debug/app-debug.apk
```

### 使用Android Studio

1. 连接设备或启动模拟器
2. 点击运行按钮（绿色播放图标）
3. 选择目标设备
4. 应用会自动安装并启动

## 下一步

编译成功后，你可以：
1. 在设备上测试应用
2. 阅读其他文档了解项目细节
3. 开始修改和开发新功能
4. 查看代码注释学习实现细节

