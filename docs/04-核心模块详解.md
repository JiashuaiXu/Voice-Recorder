# 核心模块详解

## 1. 录制模块（Recorder）

### Recorder接口

定义了录制器的统一接口，所有录制实现都必须实现此接口。

```kotlin
interface Recorder {
    fun setOutputFile(path: String)
    fun setOutputFile(parcelFileDescriptor: ParcelFileDescriptor)
    fun prepare()
    fun start()
    fun stop()
    fun pause()
    fun resume()
    fun release()
    fun getMaxAmplitude(): Int
}
```

### MediaRecorderWrapper

使用Android原生的`MediaRecorder`实现，支持M4A和OGG格式。

**特点**:
- 使用系统API，稳定可靠
- 支持暂停/恢复（Android 8.0+）
- 配置简单

**使用场景**: M4A和OGG格式录制

**关键代码**:
```kotlin
private var recorder = MediaRecorder().apply {
    setAudioSource(context.config.microphoneMode)
    setOutputFormat(context.config.getOutputFormat())
    setAudioEncoder(context.config.getAudioEncoder())
    setAudioEncodingBitRate(context.config.bitrate)
    setAudioSamplingRate(context.config.samplingRate)
}
```

### Mp3Recorder

使用`AudioRecord` + `LAME`库实现MP3编码。

**特点**:
- 需要第三方库（TAndroidLame）
- 在后台线程中实时编码
- 手动计算振幅

**使用场景**: MP3格式录制

**关键实现**:
1. 使用`AudioRecord`采集PCM数据
2. 在后台线程中循环读取音频数据
3. 使用LAME库将PCM编码为MP3
4. 写入文件流

## 2. 服务模块（Service）

### RecorderService

后台录制服务，负责实际的录制逻辑。

#### 主要功能

1. **录制管理**
   - 开始/停止录制
   - 暂停/恢复录制
   - 取消录制

2. **状态管理**
   - `RECORDING_RUNNING`: 正在录制
   - `RECORDING_PAUSED`: 已暂停
   - `RECORDING_STOPPED`: 已停止

3. **事件广播**
   - 通过EventBus发送录制状态
   - 定时更新录制时长
   - 定时更新音频振幅（用于可视化）

4. **前台服务**
   - 显示持续通知
   - 确保录制在后台继续运行

#### 关键方法

- `startRecording()`: 初始化录制器并开始录制
- `stopRecording()`: 停止录制并保存文件
- `cancelRecording()`: 取消录制并删除文件
- `togglePause()`: 切换暂停/恢复状态
- `broadcastRecorderInfo()`: 广播录制信息

#### 文件处理

- **Android 10+ (API 29+)**: 使用SAF（Storage Access Framework）
- **Android 8-9**: 使用传统文件系统或SAF（SD卡）

## 3. UI模块（Fragment）

### RecorderFragment

录制界面，提供录制控制和可视化。

#### 主要功能

1. **录制控制**
   - 开始/暂停录制按钮
   - 保存/取消按钮
   - 录制时长显示

2. **可视化**
   - 实时音频波形显示
   - 使用AudioRecordView组件

3. **状态管理**
   - 监听EventBus事件
   - 更新UI状态
   - 暂停时按钮闪烁效果

#### 关键交互

```kotlin
// 点击录制按钮
binding.toggleRecordingButton.setOnClickListener {
    cycleRecordingState()  // 切换录制状态
}

// 监听录制状态
@Subscribe(threadMode = ThreadMode.MAIN)
fun gotStatusEvent(event: Events.RecordingStatus) {
    status = event.status
    refreshView()  // 更新UI
}
```

### PlayerFragment

播放界面，显示录音列表和播放控制。

#### 主要功能

1. **列表展示**
   - 显示所有录音文件
   - 支持搜索过滤
   - 支持多选操作

2. **播放控制**
   - 播放/暂停
   - 上一首/下一首
   - 进度条控制
   - 快进/快退（10秒）

3. **文件管理**
   - 重命名
   - 删除（支持回收站）
   - 分享

#### MediaPlayer使用

```kotlin
player = MediaPlayer().apply {
    setWakeMode(context, PowerManager.PARTIAL_WAKE_LOCK)
    setAudioAttributes(...)
    setOnCompletionListener { ... }
    setOnPreparedListener { ... }
}
```

### TrashFragment

回收站界面，显示已删除的录音。

#### 主要功能

- 显示已删除的录音
- 恢复录音
- 永久删除
- 自动清理过期文件（30天）

## 4. 适配器模块（Adapter）

### ViewPagerAdapter

管理ViewPager中的Fragment。

```kotlin
class ViewPagerAdapter(
    activity: FragmentActivity,
    showRecycleBin: Boolean
) : FragmentStateAdapter(activity)
```

**功能**:
- 根据配置决定是否显示回收站标签
- 管理Fragment生命周期

### RecordingsAdapter

录音列表的RecyclerView适配器。

**功能**:
- 显示录音信息（标题、时长、大小、日期）
- 支持多选模式
- 处理点击和长按事件

### TrashAdapter

回收站列表的RecyclerView适配器。

**功能**:
- 显示已删除的录音
- 支持恢复和永久删除

## 5. 配置模块（Config）

### Config类

继承自`BaseConfig`，管理应用的所有配置。

#### 主要配置项

1. **录制设置**
   - `saveRecordingsFolder`: 保存路径
   - `extension`: 音频格式（M4A/MP3/OGG）
   - `bitrate`: 比特率
   - `samplingRate`: 采样率
   - `microphoneMode`: 麦克风模式

2. **功能开关**
   - `recordAfterLaunch`: 启动后自动录制
   - `useRecycleBin`: 使用回收站
   - `keepScreenOn`: 录制时保持屏幕常亮

3. **其他设置**
   - `lastRecycleBinCheck`: 上次检查回收站时间
   - `wasMicModeWarningShown`: 是否显示麦克风模式警告

#### 配置存储

使用Android的`SharedPreferences`存储配置，通过`BaseConfig`提供的基础功能访问。

## 6. 扩展函数模块（Extensions）

### Context扩展

- `config`: 获取Config实例
- `ensureStoragePermission`: 确保存储权限
- `getDefaultRecordingsFolder`: 获取默认保存文件夹

### Activity扩展

- `setKeepScreenAwake`: 设置屏幕常亮

### String扩展

- 字符串工具方法

### DocumentFile扩展

- SAF文件操作辅助方法

## 7. 辅助类模块（Helpers）

### Constants

定义所有常量：
- Action常量（用于Intent）
- 状态常量
- 文件扩展名常量
- 比特率和采样率选项
- SharedPreferences键名

### MyWidgetRecordDisplayProvider

桌面小部件提供者，显示录制状态。

## 8. 事件模型（Events）

使用EventBus进行组件间通信的事件类：

- `RecordingDuration`: 录制时长更新
- `RecordingStatus`: 录制状态更新
- `RecordingAmplitude`: 音频振幅更新
- `RecordingCompleted`: 录制完成
- `RecordingSaved`: 录音保存成功
- `RecordingTrashUpdated`: 回收站更新

## 模块间通信流程

```
RecorderService (录制服务)
    ↓ (EventBus)
RecorderFragment (录制界面)
    ↓ (用户操作)
RecorderService
    ↓ (EventBus)
PlayerFragment (播放界面) - 刷新列表
```

