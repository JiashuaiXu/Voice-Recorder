# 项目架构

## 架构模式

本项目采用**MVC（Model-View-Controller）架构模式**，结合Android的标准组件（Activity、Fragment、Service）来实现。

## 核心组件层次

### 1. 表示层（Presentation Layer）

#### Activities（活动）

- **SplashActivity**: 启动画面，负责应用初始化
- **MainActivity**: 主活动，包含ViewPager和底部导航
- **SettingsActivity**: 设置页面
- **SimpleActivity**: 基础活动类，提供通用功能
- **BackgroundRecordActivity**: 后台录制活动（无界面）
- **WidgetRecordDisplayConfigureActivity**: Widget配置活动

#### Fragments（片段）

- **RecorderFragment**: 录制界面，显示录制按钮和可视化
- **PlayerFragment**: 播放界面，显示录音列表和播放控制
- **TrashFragment**: 回收站界面，显示已删除的录音
- **MyViewPagerFragment**: Fragment基类

### 2. 业务逻辑层（Business Logic Layer）

#### Services（服务）

- **RecorderService**: 后台录制服务
  - 负责音频录制逻辑
  - 管理录制状态（运行中/暂停/停止）
  - 发送录制状态更新事件
  - 显示前台通知

#### Recorder（录制器）

- **Recorder接口**: 定义录制器的统一接口
- **MediaRecorderWrapper**: 使用Android MediaRecorder实现（支持M4A、OGG）
- **Mp3Recorder**: 使用AudioRecord + LAME库实现MP3录制

### 3. 数据层（Data Layer）

#### Models（数据模型）

- **Recording**: 录音文件数据模型
  ```kotlin
  data class Recording(
      val id: Int,
      val title: String,
      val path: String,
      val timestamp: Long,
      val duration: Int,
      val size: Int
  )
  ```

- **Events**: EventBus事件类
  - `RecordingDuration`: 录制时长更新
  - `RecordingStatus`: 录制状态更新
  - `RecordingAmplitude`: 音频振幅更新（用于可视化）
  - `RecordingCompleted`: 录制完成
  - `RecordingSaved`: 录音保存成功
  - `RecordingTrashUpdated`: 回收站更新

#### Config（配置管理）

- **Config类**: 继承自BaseConfig，管理应用配置
  - 保存路径
  - 音频格式、比特率、采样率
  - 麦克风模式
  - 其他用户偏好设置

### 4. 通信机制

#### EventBus

项目使用**GreenRobot EventBus**进行组件间通信：

- **RecorderService** → **RecorderFragment**: 发送录制状态、时长、振幅
- **RecorderService** → **PlayerFragment**: 通知录制完成，刷新列表
- **RecorderService** → **MainActivity**: 通知录制保存成功

#### Intent通信

- Activity与Service之间通过Intent进行通信
- 使用Action常量定义操作类型

## 数据流

### 录制流程

```
用户点击录制按钮
    ↓
RecorderFragment.startRecording()
    ↓
启动 RecorderService
    ↓
RecorderService.startRecording()
    ↓
创建 Recorder (MediaRecorderWrapper 或 Mp3Recorder)
    ↓
开始录制，启动定时器
    ↓
定时发送事件 (Duration, Status, Amplitude)
    ↓
EventBus 分发事件
    ↓
RecorderFragment 更新UI
```

### 播放流程

```
用户选择录音文件
    ↓
PlayerFragment.playRecording()
    ↓
初始化 MediaPlayer
    ↓
设置数据源并准备
    ↓
开始播放，启动进度更新定时器
    ↓
定时更新播放进度
    ↓
用户操作（暂停/快进/快退）
```

## 关键设计模式

1. **策略模式**: Recorder接口的不同实现（MediaRecorderWrapper、Mp3Recorder）
2. **观察者模式**: EventBus实现组件间解耦通信
3. **单例模式**: Config类使用单例模式管理配置
4. **适配器模式**: ViewPagerAdapter、RecordingsAdapter等

## 模块依赖关系

```
MainActivity
    ├── ViewPagerAdapter
    │   ├── RecorderFragment
    │   │   └── RecorderService
    │   │       └── Recorder (接口)
    │   │           ├── MediaRecorderWrapper
    │   │           └── Mp3Recorder
    │   ├── PlayerFragment
    │   │   └── RecordingsAdapter
    │   └── TrashFragment
    │       └── TrashAdapter
    └── EventBus (全局通信)
```

